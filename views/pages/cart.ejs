<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= title %></title>

  <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Hide scrollbar but keep swipe */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;  /* IE & Edge */
      scrollbar-width: none;     /* Firefox */
    }

    @keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(40px); }
  to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
  animation: fadeIn 0.8s ease-out forwards;
}

.animate-slide-up {
  animation: slideUp 1s ease-out forwards;
}

@keyframes fadeUp {
  from {
    opacity: 0;
    transform: translateY(40px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.fade-up {
  animation: fadeUp 0.8s ease-out forwards;
}



  </style>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
  />
  
</head>

<body class="bg-slate-50 text-slate-800">
<%- include("../partials/toast.ejs") %>
<!--  HEADER  -->
<%- include("../partials/client/header.ejs") %>

<!--  MAIN  -->
<section class="max-w-7xl mx-auto px-6 py-14">

  <h1 class="text-3xl font-semibold text-slate-900 mb-10">
    Your Cart
  </h1>

  <% if (!cartItems || cartItems.length === 0) { %>

    <!--  EMPTY STATE  -->
    <div class="bg-white border border-slate-200 rounded-2xl p-16 text-center">

      <div class="w-16 h-16 mx-auto bg-slate-50 rounded-full flex items-center justify-center mb-6">
        <i class="fas fa-shopping-cart text-slate-600 text-xl"></i>
      </div>

      <h2 class="text-xl font-semibold text-slate-900 mb-3">
        Your cart is empty
      </h2>

      <p class="text-slate-500 mb-8">
        Looks like you haven’t added any services yet.
      </p>

      <a href="/services"
        class="inline-block px-6 py-3 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition">
        Browse Services
      </a>

    </div>

  <% } else { %>

    <!--  CART LAYOUT  -->
    <div class="grid grid-cols-12 gap-10">

      <!-- LEFT SIDE: ITEMS -->
      <div class="col-span-8 space-y-6">

        <% cartItems.forEach(item => { %>

          <a href="/services/<%=item.serviceId._id %>">
            <div class="bg-white border border-slate-200 rounded-2xl p-6 flex justify-between items-center">

            <div class="flex items-center gap-5">

              <img 
                src="<%= item.image %>" 
                class="w-20 h-20 rounded-lg object-cover border"
              />

              <div>
                <h3 class="font-semibold text-slate-900">
                  <%= item.name %>
                </h3>

                <p class="text-sm text-slate-500">
                  <%= item.description || "Premium home service" %>
                </p>

                <div class="mt-3 flex items-center gap-3 text-sm">
                  <span class="text-slate-600">Qty:</span>

                  <form method="POST" action="/cart/update/<%= item.serviceId._id %>?_method=PUT">
                    <input type="number"
                    name="quantity"
                    value="<%= item.quantity %>"
                    min="1"
                    oninput="this.form.submit()"
                    class="w-16 border rounded-md px-2 py-1">
                  </form>
                </div>

              </div>

            </div>

            <div class="text-right">
              <p class="text-lg font-semibold text-slate-900">
                ₹<%= item.price * item.quantity %>
              </p>

              <form method="POST" action="/cart/remove/<%= item?.serviceId._id %>?_method=DELETE">
                <button class="text-sm text-red-500 hover:underline mt-3">
                  Remove
                </button>
              </form>
            </div>

          </div>
          </a>
          

        <% }) %>

      </div>

      <!-- RIGHT SIDE: SUMMARY -->
      <div class="col-span-4">

  <div class="bg-white border border-slate-200 rounded-2xl p-6 sticky top-24">

    <h3 class="text-lg font-semibold mb-6">
      Order Summary
    </h3>

    <div class="space-y-4 text-sm">

      <div class="flex justify-between">
        <span class="text-slate-600">Subtotal</span>
        <span id="subtotal">₹<%= subtotal %></span>
      </div>

      <hr>

      <div class="flex justify-between">
        <span class="text-slate-600">Service Fee</span>
        <span id="serviceFee">₹<%= serviceFee || 0 %></span>
      </div>

      <hr>

      <div class="flex justify-between">
        <span class="text-slate-600">Discount</span>
        <span id="discount">- ₹<%= discount || 0 %></span>
      </div>

      <hr>

      <div class="flex justify-between text-base font-semibold">
        <span>Total</span>
        <span id="total">₹<%= total %></span>
      </div>

    </div>


    <!--  COUPON INPUT  -->
    <div class="mt-6">

      <label class="text-sm font-medium text-slate-700">
        Discount Coupon
      </label>

      <div class="flex gap-2 mt-2">

        <input
          id="couponInput"
          type="text"
          placeholder="Enter coupon code"
          class="flex-1 px-4 py-2 border border-slate-300 rounded-lg
          focus:ring-2 focus:ring-slate-500 outline-none text-sm"
        >

        <button
          id="applyCouponBtn"
          type="button"
          class="px-4 py-2 bg-slate-900 text-white rounded-lg
          hover:bg-slate-700 text-sm font-medium transition">
          Apply
        </button>

      </div>

      <p id="couponMsg" class="text-xs mt-2 hidden"></p>

    </div>

    <button
  id="payBtn"
  data-cart-id="<%= cartId %>"
  class="w-full py-3 bg-slate-900 text-white rounded-lg hover:bg-slate-700 transition font-medium mt-8">
  Proceed to Payment
</button>

    <p class="text-xs text-slate-400 text-center mt-4">
      Secure checkout • Trusted professionals
    </p>

  </div>

</div>
</div>

  <% } %>

</section>

<%- include("../partials/client/footer.ejs") %>



<script>
document.getElementById("applyCouponBtn").addEventListener("click", applyCoupon);
document.getElementById("couponInput").addEventListener("keypress", function(e){
  if(e.key === "Enter"){
    e.preventDefault();
    applyCoupon();
  }
});

async function applyCoupon(){

  const code = document.getElementById("couponInput").value.trim();
  if(!code) return;

  const msg = document.getElementById("couponMsg");

  msg.classList.remove("hidden");
  msg.textContent = "Checking coupon...";
  msg.className = "text-xs mt-2 text-slate-500";

  try{

    const res = await fetch("/api/coupon/apply",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ coupon: code })
    });

    const data = await res.json();

    if(data.success){

      document.getElementById("discount").innerText = `- ₹${data.discount}`;
      document.getElementById("total").innerText = `₹${data.total}`;

      msg.textContent = "Coupon applied successfully ✓";
      msg.className = "text-xs mt-2 text-green-600";

    }else{

      msg.textContent = data.message || "Invalid coupon";
      msg.className = "text-xs mt-2 text-red-600";

    }

  }catch(err){

    msg.textContent = "Error applying coupon";
    msg.className = "text-xs mt-2 text-red-600";

  }

}
</script>

<%- include("../partials/client/profile-script.ejs") %>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
document.getElementById("payBtn").addEventListener("click", async function () {

  const cartId = this.dataset.cartId;

  try {

    const response = await fetch("/payment/create-order", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ cartId })
    });

    const data = await response.json();

    if (!data.success) {
      alert("Unable to create order");
      return;
    }

    const options = {
      key: data.key,
      amount: data.amount,
      currency: data.currency,
      name: "FixOra Services",
      description: "Service Payment",
      order_id: data.orderId,

      handler: async function (response) {

        const verifyRes = await fetch("/payment/verify", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(response)
        });

        const verifyData = await verifyRes.json();

        if (verifyData.success) {
          window.location.href = "/payment-success";
        } else {
          alert("Payment verification failed");
        }
      },

      prefill: {
        name: "<%= user?.name || '' %>",
        email: "<%= user?.email || '' %>"
      },

      theme: {
        color: "#0f172a"
      }
    };

    const rzp = new Razorpay(options);
    rzp.open();

  } catch (error) {
    alert("Something went wrong");
  }

});
</script>
<%- include("../partials/toast-script.ejs") %>
</body>
</html>
