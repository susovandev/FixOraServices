<!-- ðŸ”” REALTIME NOTIFICATION CONTAINER -->
<div id="notification-container" class="fixed top-20 right-6 w-80 z-[9999] space-y-3"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  socket.on('connect', () => {
    console.log('Connected to socket.io');
  });

  const adminId = '<%= admin._id %>';

  socket.emit('admin:room', adminId);

  socket.on('notification:new', (data) => {
    const container = document.getElementById('notification-container');

    // Notification Toast container
    const toast = document.createElement('div');
    toast.className = 'relative bg-indigo-50 border border-indigo-200 p-3 rounded';

    toast.innerHTML = `
      <button class="absolute top-2 right-2 text-gray-400 hover:text-gray-700">
        <i class="fa-solid fa-xmark text-sm"></i>
      </button>
      <p class="text-sm font-medium pr-6">${data.message}</p>
      <p class="text-xs text-gray-500">Just now</p>
    `;

    toast.querySelector('button').onclick = () => toast.remove();
    container.prepend(toast);

    // Increment bell count
    let badge = document.getElementById('notification-badge');
    if (!badge) {
      badge = document.createElement('span');
      badge.id = 'notification-badge';
      badge.className =
        'absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full font-medium';
      badge.innerText = '1';
      document.getElementById('notification-bell').appendChild(badge);
    } else {
      badge.innerText = Number(badge.innerText) + 1;
    }

    const list = document.getElementById('notification-list');
    if (!list) return;

    const item = document.createElement('div');
    item.className =
      'notification-item relative flex gap-3 px-4 py-3 border-b text-sm bg-indigo-50/60 hover:bg-indigo-50 transition';
    item.dataset.id = data._id;
    item.dataset.read = 'false';

    item.innerHTML = `
      <span class="absolute left-0 top-0 h-full w-1 bg-indigo-500"></span>

      <div class="mt-1 text-indigo-600 shrink-0">
        <i class="fa-solid fa-circle-info"></i>
      </div>

      <div class="flex-1">
        <p class="text-gray-900 font-medium">${data.message}</p>
        <span class="text-xs text-gray-400">Just now</span>
      </div>

      <span class="mt-2 w-2 h-2 bg-indigo-500 rounded-full"></span>

      <button
        class="view-notification text-xs text-indigo-600 hover:underline ml-2"
        data-url="${data.redirectUrl}"
      >
        View
      </button>
    `;

    list.prepend(item);
  });
</script>

<script>
  document.addEventListener('click', (e) => {
    // VIEW redirect
    const viewBtn = e.target.closest('.view-notification');
    if (viewBtn) {
      e.stopPropagation();
      return (window.location.href = viewBtn.dataset.url);
    }

    // Mark read
    const item = e.target.closest('.notification-item');
    if (!item) return;

    const id = item.dataset.id;
    if (!id) {
      console.error('Notification id missing', item);
      return;
    }

    if (item.dataset.read === 'true') return;

    fetch(`/admins/notifications/${id}/read`, { method: 'PATCH' }).catch(() => {});

    item.dataset.read = 'true';
    item.classList.remove('bg-indigo-50/60');
    item.classList.add('hover:bg-gray-50');
    item.querySelector('.w-1')?.remove();
    item.querySelector('.w-2')?.remove();

    const badge = document.getElementById('notification-badge');
    if (badge) {
      const count = Math.max(0, Number(badge.innerText) - 1);
      count === 0 ? badge.remove() : (badge.innerText = count);
    }
  });
</script>

<script>
  const bell = document.getElementById('notification-bell');
  const dropdown = document.getElementById('notification-dropdown');

  bell.addEventListener('click', () => {
    dropdown.classList.toggle('hidden');
  });

  document.addEventListener('click', (e) => {
    if (!bell.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.classList.add('hidden');
    }

    const viewBtn = e.target.closest('.view-notification');
    if (viewBtn) {
      e.stopPropagation();
      window.location.href = viewBtn.dataset.url;
    }
  });
</script>
