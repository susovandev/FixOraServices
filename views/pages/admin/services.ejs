<html>
  <%- include('../../partials/head.ejs', { title: pageTitle || 'Services' }) %>

  <body class="bg-gray-50 min-h-screen">
    <%- include("../../partials/toast.ejs") %>

  <div class="flex min-h-screen">

    <!-- SIDEBAR -->
    <%- include('./components/sidebar.ejs') %>

    <!-- MAIN -->
    <div class="flex-1 flex flex-col">

      <!-- TOP BAR -->
      <%- include('./components/main-header.ejs') %>

      <!-- CONTENT -->
      <main class="flex-1 p-6 space-y-6">

        <!-- HEADER -->
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-semibold text-slate-800">
              Service Categories
            </h1>
            <p class="text-sm text-slate-500">
              Manage service groups and availability
            </p>
          </div>

          <button
            data-open-modal="create-service"         
            class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl text-sm font-semibold
             shadow-sm hover:bg-indigo-700 transition flex items-center gap-2"
          >
            <i class="fa-solid fa-plus"></i>
            New Service
          </button>
        </div>

        <!-- TABLE CARD -->
        <div  class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-visible">

          <table class="w-full text-sm">
            <thead class="bg-gray-50 text-slate-600">
              <tr>
                <th class="px-6 py-4 text-left">Category</th>
                <th class="px-6 py-4 text-left">name</th>
                <th class="px-6 py-4 text-left">Base Duration</th>
                <th class="px-6 py-4 text-left">Total Bookings</th>
                <th class="px-6 py-4 text-left">Status</th>
                <th class="px-6 py-4 text-left">Created</th>
                <th class="px-6 py-4 text-right">Actions</th>
              </tr>
            </thead>

            <tbody class="divide-y">

            <% if (!services.length) { %>
              <!-- EMPTY -->
              <tr>
                <td colspan="6" class="px-6 py-20 text-center">
                  <div class="flex flex-col items-center gap-3">
                    <div class="w-14 h-14 flex items-center justify-center rounded-full bg-indigo-50 text-indigo-600">
                      <i class="fa-solid fa-layer-group text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">
                      No service found
                    </h3>
                    <p class="text-sm text-gray-500 max-w-md">
                      Create a new service to group your services and manage pricing easily.
                    </p>
                  </div>
                </td>
              </tr>
            <% } else { %>

              <% services.forEach(service => { %>
                <tr class="hover:bg-gray-50/70 transition">

                  <!-- CATEGORY NAME -->
                  <td  class="px-5 py-4 text-left">
                    <span class="px-6 py-4 font-medium text-slate-800">
                      <%= service.categoryName || 'N/A' %>
                    </span>
                  </td>

                  <!-- SERVICE NAME -->
                  <td class="px-5 py-4 text-left">
                    <span class="px-6 py-4 font-medium text-slate-800">
                      <%= service.name %>
                    </span>
                  </td>

                  <!-- BASE DURATION -->
                  <td class="px-5 py-4 text-left">
                    <span class="inline-flex items-center gap-1 px-3 py-1
             text-xs rounded-full bg-indigo-100/70
             text-indigo-700 font-semibold">
                      <%= service.baseDurationMinutes %>m
                    </span>
                  </td>

                  <!-- BOOKING COUNT -->
                  <td class="px-5 py-4 text-left">
                    <span class="inline-flex items-center gap-1 px-3 py-1
             text-xs rounded-full bg-indigo-100/70
             text-indigo-700 font-semibold">
                      <%= service.bookingCount || 0 %> <%= service.bookingCount === 1 ? 'booking' : 'bookings' %>
                    </span>
                  </td>

                  <!-- STATUS -->
                  <td class="px-5 py-4 text-left">
                    <% if (service.isActive) { %>
                      <span class="inline-flex items-center gap-2 px-3 py-1 text-xs
             bg-emerald-100/70 text-emerald-700
             rounded-full font-semibold">
                        ‚óè Active
                      </span>
                    <% } else { %>
                      <span class="inline-flex items-center gap-2 px-3 py-1 text-xs
             bg-rose-100/70 text-rose-700
             rounded-full font-semibold">
                        ‚óè Disabled
                      </span>
                    <% } %>
                  </td>

                  <!-- CREATED -->
                  <td class="px-5 py-4 text-slate-500 text-left">
                    <%= new Date(service.createdAt).toDateString() %>
                  </td>

                  <!-- ACTIONS -->
                  <td class="px-5 py-4 text-right">
  <div class="relative inline-block text-left">
    <button
      class="p-2 rounded-full text-slate-500 hover:bg-slate-100 hover:text-slate-700 transition"
      onclick="toggleActionMenu('<%= service._id %>')"
    >
      <i class="fa-solid fa-ellipsis-vertical"></i>
    </button>

    <div
      id="actions-<%= service._id %>"
      class="hidden absolute right-0 mt-2 w-40
             bg-white border border-gray-200
             rounded-xl shadow-xl z-999 overflow-hidden"
    >
      <!-- EDIT -->
      <button
        class="w-full px-4 py-2.5 text-sm text-left
               text-slate-700 hover:bg-slate-100 transition
              edit-service-btn"
  data-id="<%= service._id %>"
  data-name="<%- service.name %>"
  data-description="<%- service.description %>"
  data-duration="<%= service.baseDurationMinutes %>"
  data-category-id="<%= service.categoryId._id || service.categoryId %>"
      >
        ‚úèÔ∏è Edit
      </button>

      <!-- TOGGLE -->
      <form
        action="/admin/services/<%= service._id %>/toggle?_method=PUT"
        method="POST"
      >
        <button
          class="w-full px-4 py-2.5 text-sm text-left transition
            <%= service.isActive
              ? 'text-rose-600 hover:bg-rose-50'
              : 'text-emerald-600 hover:bg-emerald-50' %>"
        >
          <%= service.isActive ? 'Disable' : 'Enable' %>
        </button>
      </form>

      <!-- DELETE -->
      <form
        action="/admin/services/<%= service._id %>?_method=DELETE"
        method="POST"
      >
        <button
          class="w-full px-4 py-2.5 text-sm text-left
                 text-rose-600 hover:bg-rose-50 transition"
        >
          üóë Delete
        </button>
      </form>
    </div>
  </div>
</td>
</tr>
<% }) %>
<% } %>
</tbody>
</table>
</div>
</main>

      <%- include('./components/footer.ejs') %>
    </div>
  </div>

<!-- CREATE SERVICE MODAL -->
<div
  id="create-service-modal"
  class="modal fixed inset-0 hidden items-center justify-center bg-black/40 backdrop-blur-sm z-50"
>
  <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl">

    <h3 class="text-lg font-semibold text-gray-900 mb-5">
      Create Service
    </h3>

    <form action="/admin/services" method="POST" class="space-y-4">

      <!-- CATEGORY SELECT -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Category
        </label>
        <select
          name="categoryId"
          required
          class="w-full px-4 py-2.5 rounded-xl border border-gray-300
                 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white"
        >
          <option value="" disabled selected>Select a category</option>
          <% categories.forEach(cat => { %>
            <option value="<%= cat._id %>"><%= cat.name %></option>
          <% }) %>
        </select>
      </div>

      <!-- SERVICE NAME -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Service Name
        </label>
        <input
          name="name"
          required
          placeholder="e.g. AC Repair"
          class="w-full px-4 py-2.5 rounded-xl border border-gray-300
                 focus:ring-2 focus:ring-indigo-500"
        />
      </div>

      <!-- DESCRIPTION -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Description
        </label>
        <textarea
          name="description"
          rows="3"
          required
          placeholder="Short service description"
          class="w-full px-4 py-2.5 rounded-xl border border-gray-300
                 focus:ring-2 focus:ring-indigo-500 resize-none"
        ></textarea>
      </div>

      <!-- BASE DURATION -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Base Duration (minutes)
        </label>
        <input
          type="number"
          name="baseDurationMinutes"
          min="10"
          required
          placeholder="60"
          class="w-full px-4 py-2.5 rounded-xl border border-gray-300
                 focus:ring-2 focus:ring-indigo-500"
        />
      </div>

      <!-- ACTIONS -->
      <div class="flex justify-end gap-3 pt-4">
        <button
          type="button"
          data-close-modal
          class="px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50"
        >
          Cancel
        </button>
        <button
          class="px-5 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg hover:bg-indigo-700"
        >
          Create Service
        </button>
      </div>

    </form>
  </div>
</div>

<!-- EDIT SERVICE MODAL -->
<div
  id="editServiceModal"
  class="modal fixed inset-0 hidden items-center justify-center bg-black/40 z-50"
>
  <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-xl">

    <h3 class="text-lg font-semibold text-gray-900 mb-5">
      Update Service
    </h3>

    <form id="editServiceForm" method="POST" class="space-y-4">
      <input type="hidden" name="_method" value="PUT" />

      <!-- CATEGORY -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Category
        </label>
        <select
          id="editCategoryId"
          name="categoryId"
          required
          class="w-full px-4 py-2.5 rounded-xl border border-gray-300 bg-white"
        >
          <% categories.forEach(cat => { %>
            <option value="<%= cat._id %>"><%= cat.name %></option>
          <% }) %>
        </select>
      </div>

      <!-- NAME -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Service Name
        </label>
        <input
          id="editName"
          name="name"
          required
          class="w-full px-4 py-2.5 rounded-xl border border-gray-300"
        />
      </div>

      <!-- DESCRIPTION -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Description
        </label>
        <textarea
          id="editDescription"
          name="description"
          rows="3"
          required
          class="w-full px-4 py-2.5 rounded-xl border border-gray-300 resize-none"
        ></textarea>
      </div>

      <!-- DURATION -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Base Duration (minutes)
        </label>
        <input
          id="editDuration"
          type="number"
          name="baseDurationMinutes"
          min="10"
          required
          class="w-full px-4 py-2.5 rounded-xl border border-gray-300"
        />
      </div>

      <!-- ACTIONS -->
      <div class="flex justify-end gap-3 pt-4">
        <button
          type="button"
          onclick="closeEditModal()"
          class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
        >
          Cancel
        </button>
        <button
          class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
        >
          Update Service
        </button>
      </div>

    </form>
  </div>
</div>


<script>
  document.querySelectorAll('[data-open-modal]').forEach(btn => {
    btn.addEventListener('click', () => {
      const modalId = btn.dataset.openModal + '-modal';
      const modal = document.getElementById(modalId);

      if (!modal) {
        console.error('Modal not found:', modalId);
        return;
      }

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    });
  });

  // CLOSE MODAL
  document.querySelectorAll('[data-close-modal]').forEach(btn => {
    btn.addEventListener('click', () => {
      const modal = btn.closest('.modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    });
  });

  // CLICK OUTSIDE TO CLOSE
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', e => {
      if (e.target === modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    });
  });

  document.querySelectorAll('.edit-service-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    editName.value = btn.dataset.name;
    editDescription.value = btn.dataset.description;
    editDuration.value = btn.dataset.duration;
    editCategoryId.value = btn.dataset.categoryId;

    editServiceForm.action =
      `/admin/services/${btn.dataset.id}?_method=PUT`;

    editServiceModal.classList.remove('hidden');
    editServiceModal.classList.add('flex');
  });
});


    // CLOSE EDIT MODAL
    function closeEditModal() {
      document.getElementById('editServiceModal').classList.add('hidden');
    }
</script>

  <script>
  function toggleActionMenu(id) {
    document.querySelectorAll('[id^="actions-"]').forEach(m => {
      if (m.id !== `actions-${id}`) m.classList.add('hidden');
    });

    document
      .getElementById(`actions-${id}`)
      .classList.toggle('hidden');
  }

  document.addEventListener('click', e => {
    if (!e.target.closest('[onclick^="toggleActionMenu"]')) {
      document
        .querySelectorAll('[id^="actions-"]')
        .forEach(m => m.classList.add('hidden'));
    }
  });
</script>


  <%- include('../../partials/toast-script.ejs') %>
  </body>

</html>